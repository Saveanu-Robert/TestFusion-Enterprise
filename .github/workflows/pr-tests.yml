name: PR Tests

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, labeled, unlabeled]
  push:
    branches: [ feature/*, bugfix/*, hotfix/* ]

env:
  NODE_VERSION: '20'

jobs:
  detect-test-type:
    name: Detect Test Type
    runs-on: ubuntu-latest
    outputs:
      test-api: ${{ steps.detect.outputs.test-api }}
      test-web: ${{ steps.detect.outputs.test-web }}
      test-all: ${{ steps.detect.outputs.test-all }}
      run-lint: ${{ steps.detect.outputs.run-lint }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect test scope
        id: detect
        run: |
          # Default values
          TEST_API="false"
          TEST_WEB="false"
          TEST_ALL="false"
          RUN_LINT="true"
          
          # Check for PR labels (if this is a PR)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
            echo "PR Labels: $LABELS"
            
            if [[ "$LABELS" == *"test:all"* ]]; then
              TEST_ALL="true"
              echo "ðŸš€ Running ALL tests due to 'test:all' label"
            elif [[ "$LABELS" == *"test:api"* ]]; then
              TEST_API="true"
              echo "ðŸ”§ Running API tests due to 'test:api' label"
            elif [[ "$LABELS" == *"test:web"* ]]; then
              TEST_WEB="true"
              echo "ðŸŒ Running WEB tests due to 'test:web' label"
            elif [[ "$LABELS" == *"skip-tests"* ]]; then
              echo "â­ï¸ Skipping tests due to 'skip-tests' label"
            else
              # Auto-detect based on changed files
              echo "ðŸ” Auto-detecting test scope from changed files..."
              
              # Get changed files
              git diff --name-only origin/main...HEAD > changed_files.txt
              cat changed_files.txt
              
              # Check for API-related changes
              if grep -E "(tests/api/|tests/operations/|tests/validators/|tests/clients/api)" changed_files.txt; then
                TEST_API="true"
                echo "ðŸ“¡ API tests detected from file changes"
              fi
              
              # Check for Web/UI-related changes
              if grep -E "(tests/pages/|tests/web/|tests/ui/|\.page\.ts|playwright\.config)" changed_files.txt; then
                TEST_WEB="true"
                echo "ðŸŒ Web tests detected from file changes"
              fi
              
              # Check for core framework changes (run all tests)
              if grep -E "(tests/config/|tests/fixtures/|tests/utils/|package\.json|tsconfig|eslint)" changed_files.txt; then
                TEST_ALL="true"
                echo "âš™ï¸ Core framework changes detected - running all tests"
              fi
              
              # If no specific changes detected, run API tests (default)
              if [[ "$TEST_API" == "false" && "$TEST_WEB" == "false" && "$TEST_ALL" == "false" ]]; then
                TEST_API="true"
                echo "ðŸ”§ No specific changes detected - defaulting to API tests"
              fi
            fi
          else
            # For push events, auto-detect based on branch name and changes
            echo "ðŸ“ Push event detected - auto-detecting from branch and changes..."
            
            BRANCH_NAME="${{ github.ref_name }}"
            echo "Branch: $BRANCH_NAME"
            
            # Get changed files compared to main
            git diff --name-only origin/main...HEAD > changed_files.txt
            cat changed_files.txt
            
            # Branch-based detection
            if [[ "$BRANCH_NAME" == *"api"* ]]; then
              TEST_API="true"
              echo "ðŸ“¡ API tests from branch name"
            elif [[ "$BRANCH_NAME" == *"web"* ]] || [[ "$BRANCH_NAME" == *"ui"* ]]; then
              TEST_WEB="true"
              echo "ðŸŒ Web tests from branch name"
            else
              # File-based detection for push events
              if grep -E "(tests/api/|tests/operations/|tests/validators/|tests/clients/api)" changed_files.txt; then
                TEST_API="true"
                echo "ðŸ“¡ API tests from file changes"
              fi
              
              if grep -E "(tests/pages/|tests/web/|tests/ui/|\.page\.ts)" changed_files.txt; then
                TEST_WEB="true"
                echo "ðŸŒ Web tests from file changes"
              fi
              
              # Core changes = all tests
              if grep -E "(tests/config/|tests/fixtures/|tests/utils/|package\.json|tsconfig|eslint)" changed_files.txt; then
                TEST_ALL="true"
                echo "âš™ï¸ Core changes - running all tests"
              fi
              
              # Default for push
              if [[ "$TEST_API" == "false" && "$TEST_WEB" == "false" && "$TEST_ALL" == "false" ]]; then
                TEST_API="true"
                echo "ðŸ”§ Default to API tests for push"
              fi
            fi
          fi
          
          echo "test-api=$TEST_API" >> $GITHUB_OUTPUT
          echo "test-web=$TEST_WEB" >> $GITHUB_OUTPUT
          echo "test-all=$TEST_ALL" >> $GITHUB_OUTPUT
          echo "run-lint=$RUN_LINT" >> $GITHUB_OUTPUT
          
          echo "Final test configuration:"
          echo "  API Tests: $TEST_API"
          echo "  Web Tests: $TEST_WEB"
          echo "  All Tests: $TEST_ALL"
          echo "  Run Lint: $RUN_LINT"

  lint:
    name: Code Quality (ESLint)
    runs-on: ubuntu-latest
    needs: detect-test-type
    if: needs.detect-test-type.outputs.run-lint == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint:check

  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    needs: detect-test-type
    if: needs.detect-test-type.outputs.test-api == 'true' || needs.detect-test-type.outputs.test-all == 'true'
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run API tests
        run: |
          if [ "${{ needs.detect-test-type.outputs.test-all }}" = "true" ]; then
            echo "ðŸš€ Running ALL tests"
            npx playwright test --project=${{ matrix.browser }} --reporter=html
          else
            echo "ðŸ“¡ Running API tests only"
            npx playwright test tests/api/ --project=${{ matrix.browser }} --reporter=html
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  web-tests:
    name: Web/UI Tests
    runs-on: ubuntu-latest
    needs: detect-test-type
    if: needs.detect-test-type.outputs.test-web == 'true' || needs.detect-test-type.outputs.test-all == 'true'
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run Web/UI tests
        run: |
          if [ "${{ needs.detect-test-type.outputs.test-all }}" = "true" ]; then
            echo "ðŸš€ Running ALL tests"
            npx playwright test --project=${{ matrix.browser }} --reporter=html
          else
            echo "ðŸŒ Running Web/UI tests only"
            # Check if web test directory exists, otherwise skip
            if [ -d "tests/web" ] || [ -d "tests/ui" ] || find tests/ -name "*.page.spec.ts" | grep -q .; then
              npx playwright test tests/web/ tests/ui/ tests/pages/ --project=${{ matrix.browser }} --reporter=html || echo "No web tests found, skipping"
            else
              echo "âš ï¸ No web tests directory found, skipping web tests"
            fi
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-test-results-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-test-type, lint, api-tests, web-tests]
    if: always()
    steps:
      - name: Generate test summary
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **API Tests**: ${{ needs.detect-test-type.outputs.test-api }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Tests**: ${{ needs.detect-test-type.outputs.test-web }}" >> $GITHUB_STEP_SUMMARY
          echo "- **All Tests**: ${{ needs.detect-test-type.outputs.test-all }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Linting**: ${{ needs.detect-test-type.outputs.run-lint }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint**: ${{ needs.lint.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Tests**: ${{ needs.api-tests.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Tests**: ${{ needs.web-tests.result || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          OVERALL="âœ… Success"
          if [ "${{ contains(needs.*.result, 'failure') }}" = "true" ]; then
            OVERALL="âŒ Failed"
          elif [ "${{ contains(needs.*.result, 'cancelled') }}" = "true" ]; then
            OVERALL="â¹ï¸ Cancelled"
          fi
          
          echo "### Overall Status: $OVERALL" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ PR Testing Tips" >> $GITHUB_STEP_SUMMARY
            echo "- Use \`test:api\` label to run only API tests" >> $GITHUB_STEP_SUMMARY
            echo "- Use \`test:web\` label to run only Web/UI tests" >> $GITHUB_STEP_SUMMARY
            echo "- Use \`test:all\` label to run all tests" >> $GITHUB_STEP_SUMMARY
            echo "- Use \`skip-tests\` label to skip all tests" >> $GITHUB_STEP_SUMMARY
            echo "- Tests are auto-detected based on changed files if no labels are used" >> $GITHUB_STEP_SUMMARY
          fi
