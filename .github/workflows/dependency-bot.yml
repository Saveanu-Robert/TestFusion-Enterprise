name: Dependency Bot

on:
  schedule:
    # Run every morning at 7:00 AM UTC (Monday to Friday)
    - cron: '0 7 * * 1-5'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  check-dependencies:
    name: Check & Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPENDENCY_BOT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --global user.name 'dependency-bot[bot]'
          git config --global user.email 'dependency-bot[bot]@users.noreply.github.com'

      - name: Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: Check for dependency updates
        id: check-updates
        run: |
          echo "ğŸ” Checking for dependency updates..."
            # Check what can be updated (only actual updates, not current versions)
          ncu --jsonUpgraded > updates.json
          
          # Check if there are any updates available
          if [ "$(cat updates.json)" = "{}" ]; then
            echo "âœ… All dependencies are up to date!"
            echo "has-updates=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "ğŸ“¦ Dependencies that can be updated:"
            ncu --format group
            echo "has-updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Create dependency update branch
        if: steps.check-updates.outputs.has-updates == 'true'
        id: create-branch
        run: |
          # Create a unique branch name with current date
          BRANCH_NAME="dependency-updates/$(date +%Y-%m-%d)"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Check if branch already exists
          if git ls-remote --exit-code --heads origin $BRANCH_NAME; then
            echo "Branch $BRANCH_NAME already exists, using timestamp suffix"
            BRANCH_NAME="dependency-updates/$(date +%Y-%m-%d-%H%M)"
            echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸŒ¿ Creating branch: $BRANCH_NAME"
          git checkout -b $BRANCH_NAME

      - name: Update dependencies
        if: steps.check-updates.outputs.has-updates == 'true'
        run: |
          echo "ğŸ“¦ Updating dependencies..."
          
          # Update dependencies
          ncu -u
          
          # Install updated dependencies
          npm install
            echo "âœ… Dependencies updated successfully"

      - name: Run linting
        if: steps.check-updates.outputs.has-updates == 'true'
        run: |
          echo "ğŸ” Running linting checks..."
          npm run lint:check

      - name: Install Playwright browsers
        if: steps.check-updates.outputs.has-updates == 'true'
        run: |
          echo "ğŸ­ Installing Playwright browsers..."
          npx playwright install --with-deps

      - name: Load environment variables from .env
        if: steps.check-updates.outputs.has-updates == 'true'
        run: |
          echo "ğŸ“‹ Loading configuration from .env file for dependency tests..."
          if [ -f .env ]; then
            # Load .env file and export variables (excluding comments and empty lines)
            set -a
            source <(cat .env | grep -v '^#' | grep -v '^$')
            set +a
            
            # Export CI-specific overrides for dependency testing
            echo "CI_ENVIRONMENT=github-actions" >> $GITHUB_ENV
            echo "CI_BROWSER=chromium" >> $GITHUB_ENV
            echo "CI_HEADLESS=true" >> $GITHUB_ENV
            echo "CI_WORKERS=2" >> $GITHUB_ENV
            echo "CI_RETRIES=1" >> $GITHUB_ENV
            echo "CI_SCREENSHOT_MODE=only-on-failure" >> $GITHUB_ENV
            echo "CI_VIDEO_MODE=retain-on-failure" >> $GITHUB_ENV
            echo "CI_TRACE_MODE=retain-on-failure" >> $GITHUB_ENV
            
            # Export configuration from .env
            echo "API_BASE_URL=${API_BASE_URL}" >> $GITHUB_ENV
            echo "API_TIMEOUT=${API_TIMEOUT}" >> $GITHUB_ENV
            echo "API_RETRY_ATTEMPTS=${API_RETRY_ATTEMPTS}" >> $GITHUB_ENV
            echo "WEB_BASE_URL=${WEB_BASE_URL}" >> $GITHUB_ENV
            echo "WEB_NAVIGATION_TIMEOUT=${WEB_NAVIGATION_TIMEOUT}" >> $GITHUB_ENV
            echo "WEB_ELEMENT_TIMEOUT=${WEB_ELEMENT_TIMEOUT}" >> $GITHUB_ENV
            echo "WEB_ASSERTION_TIMEOUT=${WEB_ASSERTION_TIMEOUT}" >> $GITHUB_ENV
            echo "WEB_RETRY_ATTEMPTS=${WEB_RETRY_ATTEMPTS}" >> $GITHUB_ENV
            echo "WEB_HEADLESS=${CI_HEADLESS}" >> $GITHUB_ENV
            echo "WEB_SLOW_MO=${WEB_SLOW_MO}" >> $GITHUB_ENV
            echo "WEB_VIEWPORT_WIDTH=${WEB_VIEWPORT_WIDTH}" >> $GITHUB_ENV
            echo "WEB_VIEWPORT_HEIGHT=${WEB_VIEWPORT_HEIGHT}" >> $GITHUB_ENV
            echo "LOG_LEVEL=${LOG_LEVEL}" >> $GITHUB_ENV
            echo "ENABLE_REQUEST_LOGGING=${ENABLE_REQUEST_LOGGING}" >> $GITHUB_ENV
            echo "ENABLE_RESPONSE_LOGGING=${ENABLE_RESPONSE_LOGGING}" >> $GITHUB_ENV
            echo "ENABLE_SCREENSHOTS=${CI_SCREENSHOT_MODE}" >> $GITHUB_ENV
            echo "ENABLE_VIDEOS=${CI_VIDEO_MODE}" >> $GITHUB_ENV
            echo "ENABLE_TRACING=${CI_TRACE_MODE}" >> $GITHUB_ENV
            echo "PLAYWRIGHT_WORKERS=${CI_WORKERS}" >> $GITHUB_ENV
            echo "PLAYWRIGHT_RETRIES=${CI_RETRIES}" >> $GITHUB_ENV
            echo "PLAYWRIGHT_FULLY_PARALLEL=true" >> $GITHUB_ENV
            echo "PLAYWRIGHT_FORBID_ONLY=false" >> $GITHUB_ENV
            echo "PLAYWRIGHT_REPORTER=html,list" >> $GITHUB_ENV
            echo "PLAYWRIGHT_OUTPUT_DIR=test-results-dependency-check" >> $GITHUB_ENV
          else
            echo "âš ï¸ .env file not found, using defaults"
          fi

      - name: Run all tests
        if: steps.check-updates.outputs.has-updates == 'true'
        id: run-tests
        run: |
          echo "ğŸ§ª Running all tests to verify dependency updates..."
          
          # Run tests with configuration from .env
          npx playwright test --reporter=html,list --output-dir=test-results-dependency-check
          
          echo "test-status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check test results
        if: steps.check-updates.outputs.has-updates == 'true'
        id: check-tests
        run: |
          if [ "${{ steps.run-tests.outcome }}" = "failure" ]; then
            echo "âŒ Tests failed with updated dependencies"
            echo "test-status=failed" >> $GITHUB_OUTPUT
            
            # Still create PR but mark it as failing tests
            echo "TESTS_FAILED=true" >> $GITHUB_ENV
          else
            echo "âœ… All tests passed with updated dependencies"
            echo "test-status=success" >> $GITHUB_OUTPUT
            echo "TESTS_FAILED=false" >> $GITHUB_ENV
          fi

      - name: Generate change summary
        if: steps.check-updates.outputs.has-updates == 'true'
        run: |
          echo "ğŸ“‹ Generating dependency change summary..."
          
          # Create a detailed summary
          cat > DEPENDENCY_CHANGES.md << EOF
          # ğŸ¤– Automatic Dependency Updates
          
          This PR was automatically created by the dependency bot to update outdated packages.
          
          ## ğŸ“¦ Updated Dependencies
          
          \`\`\`
          $(ncu --format group)
          \`\`\`
          
          ## ğŸ§ª Test Results
          
          EOF
          
          if [ "$TESTS_FAILED" = "true" ]; then
            cat >> DEPENDENCY_CHANGES.md << EOF
          âŒ **Tests failed with these updates**
          
          Please review the test failures before merging this PR. The dependency updates may have introduced breaking changes.
          
          ### Next Steps:
          1. Review the failing tests in the test artifacts
          2. Check for breaking changes in the updated packages
          3. Update test code if necessary
          4. Re-run tests manually once fixes are applied
          
          EOF
          else
            cat >> DEPENDENCY_CHANGES.md << EOF
          âœ… **All tests passed**
          
          All automated tests have passed with the updated dependencies. This PR is ready for review and merge.
          
          EOF
          fi
          
          cat >> DEPENDENCY_CHANGES.md << EOF
          ## ğŸ”§ What was updated?
          
          - Dependencies were updated to their latest versions using \`npm-check-updates\`
          - Package-lock.json was regenerated
          - All tests were executed to ensure compatibility
          
          ## ğŸš€ How to merge?
          
          If tests are passing:
          1. Review the changes
          2. Merge this PR
          
          If tests are failing:
          1. Review the test failures
          2. Check breaking changes in updated packages
          3. Make necessary code adjustments
          4. Push additional commits to this branch
          
          ---
          
          *This PR was automatically created by the dependency bot on $(date)*
          EOF

      - name: Commit changes
        if: steps.check-updates.outputs.has-updates == 'true'
        run: |
          echo "ğŸ’¾ Committing dependency updates..."
          
          git add .
          
          if [ "$TESTS_FAILED" = "true" ]; then
            git commit -m "ğŸ¤– chore: update dependencies (âš ï¸ tests failing)

          - Updated dependencies to latest versions
          - âš ï¸ Some tests are failing with these updates
          - Please review test failures before merging
          - Generated by dependency-bot
          
          $(date)"
          else
            git commit -m "ğŸ¤– chore: update dependencies (âœ… tests passing)

          - Updated dependencies to latest versions
          - âœ… All tests passing with updates
          - Safe to merge after review
          - Generated by dependency-bot
          
          $(date)"
          fi

      - name: Push changes and create PR
        if: steps.check-updates.outputs.has-updates == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.DEPENDENCY_BOT_TOKEN }}
        run: |
          echo "ğŸš€ Pushing changes and creating PR..."
          
          # Push the branch
          git push origin ${{ steps.create-branch.outputs.branch-name }}
            # Create PR with appropriate title and details
          if [ "$TESTS_FAILED" = "true" ]; then
            gh pr create \
              --title "ğŸ¤– Dependency Updates $(date +%Y-%m-%d) âš ï¸ Tests Failing" \
              --body-file DEPENDENCY_CHANGES.md \
              --base main \
              --head ${{ steps.create-branch.outputs.branch-name }}
            
            # Try to add labels (ignore errors if labels don't exist)
            gh pr edit ${{ steps.create-branch.outputs.branch-name }} --add-label "dependencies,automated,test:all,needs-review" || echo "âš ï¸ Could not add labels (labels may not exist)"
          else
            gh pr create \
              --title "ğŸ¤– Dependency Updates $(date +%Y-%m-%d) âœ… Tests Passing" \
              --body-file DEPENDENCY_CHANGES.md \
              --base main \
              --head ${{ steps.create-branch.outputs.branch-name }}
            
            # Try to add labels (ignore errors if labels don't exist)
            gh pr edit ${{ steps.create-branch.outputs.branch-name }} --add-label "dependencies,automated,test:all,ready-to-merge" || echo "âš ï¸ Could not add labels (labels may not exist)"
          fi
          echo "âœ… PR created successfully!"

      - name: Upload test artifacts
        if: steps.check-updates.outputs.has-updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-test-results
          path: |
            test-results-dependency-check/
            enterprise-reports/
          retention-days: 14

      - name: Notify completion
        if: always()
        run: |
          if [ "${{ steps.check-updates.outputs.has-updates }}" = "true" ]; then
            if [ "$TESTS_FAILED" = "true" ]; then
              echo "ğŸ¤– Dependency bot completed with test failures"
              echo "ğŸ“§ PR created with failing tests - manual review required"
            else
              echo "ğŸ¤– Dependency bot completed successfully"
              echo "ğŸ“§ PR created with passing tests - ready for review"
            fi
          else
            echo "ğŸ¤– Dependency bot completed - no updates needed"
            echo "âœ… All dependencies are already up to date"
          fi
