name: Manual Tests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - api
        - web-local
        - web-grid
        - web-browserstack
      browser:
        description: 'Browser to use (for web tests)'
        required: false
        default: 'chromium'
        type: choice
        options:
        - chromium
        - firefox
        - webkit
      environment:
        description: 'Test environment'
        required: false
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production

# Add explicit permissions for the workflow
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  issues: write

env:
  # This is the only secret needed - the encryption key for decrypting .env values
  ENV_ENCRYPTION_KEY: ${{ secrets.ENV_ENCRYPTION_KEY }}

jobs:
  manual-test:
    timeout-minutes: 90
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Decrypt and load environment variables
      run: |
        # Process .env file to decrypt sensitive values and export all variables
        node scripts/env-crypto.js process-env .env > .env.decrypted
        
        # Export all environment variables for subsequent steps
        while IFS='=' read -r key value; do
          # Skip comments and empty lines
          if [[ ! "$key" =~ ^[[:space:]]*# ]] && [[ -n "$key" ]] && [[ "$key" =~ ^[A-Za-z_][A-Za-z0-9_]*$ ]]; then
            # Remove quotes if present and export
            value=$(echo "$value" | sed 's/^"//;s/"$//')
            echo "$key=$value" >> $GITHUB_ENV
            echo "::add-mask::$value"  # Mask sensitive values in logs
          fi
        done < .env.decrypted
        
        # Clean up temporary file
        rm -f .env.decrypted

    - name: Override environment variables based on inputs
      run: |
        # Override TEST_ENV based on workflow input
        echo "TEST_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
        
        # Override browser for web tests if specified
        if [[ "${{ github.event.inputs.browser }}" != "chromium" ]]; then
          echo "CI_BROWSER=${{ github.event.inputs.browser }}" >> $GITHUB_ENV
        fi

    - name: Install Playwright Browsers
      if: github.event.inputs.test_type != 'api'
      run: npx playwright install --with-deps

    - name: Setup Selenium Grid (for grid tests)
      if: github.event.inputs.test_type == 'web-grid' || github.event.inputs.test_type == 'all'
      run: |
        # Start Selenium Grid in the background
        docker run -d -p 4444:4444 -p 7900:7900 --shm-size=2g selenium/standalone-chrome:latest
        
        # Wait for grid to be ready
        timeout 60 bash -c 'until curl -sSf http://localhost:4444/wd/hub/status; do sleep 2; done'

    - name: Run API Tests
      if: github.event.inputs.test_type == 'api' || github.event.inputs.test_type == 'all'
      run: npm run test:api

    - name: Run Web Tests (Local)
      if: github.event.inputs.test_type == 'web-local' || github.event.inputs.test_type == 'all'
      run: npm run test:web

    - name: Run Web Tests (Grid)
      if: github.event.inputs.test_type == 'web-grid' || github.event.inputs.test_type == 'all'
      run: npm run test:web:grid

    - name: Run Web Tests (BrowserStack)
      if: github.event.inputs.test_type == 'web-browserstack' || github.event.inputs.test_type == 'all'
      run: npm run test:web:browserstack

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: manual-test-results-${{ github.event.inputs.test_type }}-${{ github.run_number }}
        path: |
          playwright-report/
          test-results/
        retention-days: 14

    - name: Upload Playwright Report
      if: always() && github.event.inputs.test_type != 'api'
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report-manual-${{ github.run_number }}
        path: playwright-report/
        retention-days: 30

    - name: Generate test results summary
      if: always()
      env:
        JOB_STATUS: ${{ job.status }}
        TEST_TYPE_INPUT: ${{ github.event.inputs.test_type }}
        ENVIRONMENT_INPUT: ${{ github.event.inputs.environment }}
        BROWSER_INPUT: ${{ github.event.inputs.browser }}
        RUN_NUMBER: ${{ github.run_number }}
        COMMIT_SHA: ${{ github.sha }}
        RUN_ID: ${{ github.run_id }}
        REPO_NAME: ${{ github.repository }}
      run: |
        # Determine status with proper emoji
        case "$JOB_STATUS" in
          "success")
            STATUS="âœ… Passed"
            STATUS_EMOJI="ðŸŽ‰"
            ;;
          "failure")
            STATUS="âŒ Failed"
            STATUS_EMOJI="ðŸ’¥"
            ;;
          "cancelled")
            STATUS="ðŸš« Cancelled"
            STATUS_EMOJI="â¹ï¸"
            ;;
          *)
            STATUS="âš ï¸ $JOB_STATUS"
            STATUS_EMOJI="â“"
            ;;
        esac
        
        # Anti-masking techniques
        COMMIT_SHORT=$(printf "%s" "$COMMIT_SHA" | head -c 8)
        RUN_NUM_DISPLAY="Run-${RUN_NUMBER}"
        NUMERIC_RUN=$(echo "$RUN_NUMBER" | tr '0-9' 'a-j' | sed 's/./&-/g')
        
        # Build URLs safely
        REPO_SAFE=$(echo "$REPO_NAME" | sed 's|/|-|g')
        RUN_LINK="https://github.com"
        RUN_LINK="${RUN_LINK}/${REPO_NAME}"
        RUN_LINK="${RUN_LINK}/actions"
        RUN_LINK="${RUN_LINK}/runs"
        RUN_LINK="${RUN_LINK}/${RUN_ID}"
        
        COMMIT_LINK="https://github.com"
        COMMIT_LINK="${COMMIT_LINK}/${REPO_NAME}"
        COMMIT_LINK="${COMMIT_LINK}/commit"
        COMMIT_LINK="${COMMIT_LINK}/${COMMIT_SHA}"
        
        REPO_LINK="https://github.com/${REPO_NAME}"
        
        # Create a comprehensive test results summary
        echo "# ${STATUS_EMOJI} Manual Test Results" > test-summary.md
        echo "" >> test-summary.md
        echo "| Field | Value |" >> test-summary.md
        echo "|-------|-------|" >> test-summary.md
        echo "| **Test Type** | ${TEST_TYPE_INPUT} |" >> test-summary.md
        echo "| **Environment** | ${ENVIRONMENT_INPUT} |" >> test-summary.md
        echo "| **Browser** | ${BROWSER_INPUT} |" >> test-summary.md
        echo "| **Status** | ${STATUS} |" >> test-summary.md
        echo "| **Run ID** | ${RUN_NUM_DISPLAY} |" >> test-summary.md
        echo "| **Commit** | ${COMMIT_SHORT} |" >> test-summary.md
        echo "| **Timestamp** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> test-summary.md
        echo "" >> test-summary.md
        
        # Add workflow links with anti-masking
        echo "## ðŸ”— Quick Links" >> test-summary.md
        echo "- ðŸƒ [View Workflow Run](${RUN_LINK})" >> test-summary.md
        echo "- ï¿½ [Repository](${REPO_LINK})" >> test-summary.md
        echo "- ï¿½ [Commit Details](${COMMIT_LINK})" >> test-summary.md
        echo "" >> test-summary.md
        
        # Add test type specific information
        case "$TEST_TYPE_INPUT" in
          "api")
            echo "## ðŸ”Œ API Test Results" >> test-summary.md
            echo "" >> test-summary.md
            echo "### What was tested:" >> test-summary.md
            echo "- âœ… JSONPlaceholder API endpoints" >> test-summary.md
            echo "- âœ… CRUD operations for posts, users, and comments" >> test-summary.md
            echo "- âœ… Data validation and response structure" >> test-summary.md
            echo "- âœ… Error handling and edge cases" >> test-summary.md
            ;;
          web*)
            echo "## ðŸŒ Web Test Results" >> test-summary.md
            echo "" >> test-summary.md
            echo "### What was tested:" >> test-summary.md
            echo "- âœ… Playwright documentation site navigation" >> test-summary.md
            echo "- âœ… Page loading and responsiveness" >> test-summary.md
            echo "- âœ… Cross-browser compatibility" >> test-summary.md
            echo "- âœ… Accessibility and user experience" >> test-summary.md
            echo "- âœ… Mobile viewport testing" >> test-summary.md
            echo "" >> test-summary.md
            echo "**Browser Used:** \`${BROWSER_INPUT}\`" >> test-summary.md
            ;;
          "all")
            echo "## ðŸš€ Full Test Suite Results" >> test-summary.md
            echo "" >> test-summary.md
            echo "### What was tested:" >> test-summary.md
            echo "- âœ… Complete API test suite" >> test-summary.md
            echo "- âœ… Full web UI test suite" >> test-summary.md
            echo "- âœ… Cross-browser compatibility" >> test-summary.md
            echo "- âœ… End-to-end user journeys" >> test-summary.md
            ;;
        esac
        
        echo "" >> test-summary.md
        
        # Display the summary in the workflow logs for debugging
        echo "==================== TEST SUMMARY ===================="
        cat test-summary.md
        echo "======================================================"

    - name: Upload test summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-summary-${{ github.event.inputs.test_type }}-${{ github.run_number }}
        path: test-summary.md
        retention-days: 30

    - name: Create enhanced job summary
      if: always()
      env:
        JOB_STATUS: ${{ job.status }}
        TEST_TYPE_INPUT: ${{ github.event.inputs.test_type }}
        RUN_ID: ${{ github.run_id }}
        REPO_NAME: ${{ github.repository }}
      run: |
        # Add the test summary to GitHub's job summary
        cat test-summary.md >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add artifacts section with proper formatting
        echo "## ðŸ“¦ Test Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The following artifacts were generated during this test run:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add artifact information
        echo "| Artifact | Description | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“Š Test Results | Complete test execution results and logs | ~6MB |" >> $GITHUB_STEP_SUMMARY
        
        if [[ "$TEST_TYPE_INPUT" != "api" ]]; then
          echo "| ðŸ“ˆ Playwright Report | Interactive HTML report with screenshots | ~6MB |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "| ðŸ“ Test Summary | Markdown summary of test execution | ~500B |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add instructions for downloading artifacts
        echo "### ðŸ’¡ How to Download Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to the [workflow run page](https://github.com/${REPO_NAME}/actions/runs/${RUN_ID})" >> $GITHUB_STEP_SUMMARY
        echo "2. Scroll down to the **Artifacts** section" >> $GITHUB_STEP_SUMMARY
        echo "3. Click on any artifact name to download it" >> $GITHUB_STEP_SUMMARY
        echo "4. Extract the downloaded ZIP file to view contents" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add next steps
        echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ "$JOB_STATUS" == "success" ]]; then
          echo "- âœ… All tests passed! No action required." >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Review the Playwright report for detailed test execution information" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Consider running additional test types if needed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Some tests failed. Please review the artifacts for details." >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Check the test logs for specific failure information" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ› ï¸ Fix any issues and re-run the tests" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Generated automatically by TestFusion-Enterprise CI/CD Pipeline*" >> $GITHUB_STEP_SUMMARY
